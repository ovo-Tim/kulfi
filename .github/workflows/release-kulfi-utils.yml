name: Release kulfi-utils

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Publish to crates.io
        run: |
          echo "${{ secrets.CARGO_REGISTRY_TOKEN }}" | cargo login

          # Function to publish package, skipping if version already exists
          publish_if_new() {
            local package=$1
            local version=$(cargo metadata --format-version 1 --no-deps | jq -r ".packages[] | select(.name == \"$package\") | .version")

            echo "Publishing $package v$version..."
            if cargo publish -p $package 2>&1 | tee /tmp/publish.log; then
              echo "✓ Successfully published $package v$version"
            else
              if grep -q "already exists" /tmp/publish.log; then
                echo "⊘ Version $version of $package already exists on crates.io. Skipping..."
              else
                echo "✗ Failed to publish $package"
                cat /tmp/publish.log
                exit 1
              fi
            fi
          }

          publish_if_new "kulfi-id52"
          publish_if_new "kulfi-utils"